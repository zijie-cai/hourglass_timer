<!DOCTYPE html>
<html>
<head>
    <title>Pixelated Digital Hourglass Visualization</title>
    <style>
        body {
            margin: 0;
            background-color: #222;
            display: flex;
            align-items: center;
            justify-content: center;
            height: 100vh;
        }

        #canvas {
            border: 1px solid #555;
            image-rendering: pixelated;
        }
    </style>
</head>
<body>
    <canvas id="canvas"></canvas>
    <script>
        const CELL_SIZE = 4; // Size of each cell in pixels
        const GRID_WIDTH = 150;
        const GRID_HEIGHT = 200;

        const canvas = document.getElementById('canvas');
        canvas.width = GRID_WIDTH * CELL_SIZE;
        canvas.height = GRID_HEIGHT * CELL_SIZE;
        const ctx = canvas.getContext('2d');

        let grid = [];
        let hourglassMask = [];

        function isInHourglass(x, y) {
            const centerX = GRID_WIDTH / 2;
            const halfHeight = GRID_HEIGHT / 2;
            const maxWidth = GRID_WIDTH;
            const minWidth = 10; // Minimum width at the center

            let width;
            if (y < halfHeight) {
                width = maxWidth - ((maxWidth - minWidth) * (y / halfHeight));
            } else {
                width = minWidth + ((maxWidth - minWidth) * ((y - halfHeight) / halfHeight));
            }
            const halfWidth = width / 2;
            const leftX = centerX - halfWidth;
            const rightX = centerX + halfWidth;

            return x >= leftX && x <= rightX;
        }

        // Initialize grid and hourglass mask
        for (let y = 0; y < GRID_HEIGHT; y++) {
            grid[y] = [];
            hourglassMask[y] = [];
            for (let x = 0; x < GRID_WIDTH; x++) {
                hourglassMask[y][x] = isInHourglass(x, y);
                if (hourglassMask[y][x]) {
                    if (y < GRID_HEIGHT / 2) {
                        grid[y][x] = 1; // Sand
                    } else {
                        grid[y][x] = 0; // Empty
                    }
                } else {
                    grid[y][x] = -1; // Outside hourglass
                }
            }
        }

        function updateGrid() {
            let newGrid = [];
            for (let y = 0; y < GRID_HEIGHT; y++) {
                newGrid[y] = grid[y].slice();
            }

            // Process from bottom to top
            for (let y = GRID_HEIGHT - 1; y >= 0; y--) {
                for (let x = 0; x < GRID_WIDTH; x++) {
                    if (grid[y][x] == 1) {
                        // Sand grain
                        if (y + 1 < GRID_HEIGHT && hourglassMask[y + 1][x] && grid[y + 1][x] == 0) {
                            // Move down
                            newGrid[y][x] = 0;
                            newGrid[y + 1][x] = 1;
                        } else if (y + 1 < GRID_HEIGHT) {
                            // Check left and right
                            if (x > 0 && hourglassMask[y + 1][x - 1] && grid[y + 1][x - 1] == 0) {
                                // Move down-left
                                newGrid[y][x] = 0;
                                newGrid[y + 1][x - 1] = 1;
                            } else if (x + 1 < GRID_WIDTH && hourglassMask[y + 1][x + 1] && grid[y + 1][x + 1] == 0) {
                                // Move down-right
                                newGrid[y][x] = 0;
                                newGrid[y + 1][x + 1] = 1;
                            }
                            // Else stays in place
                        }
                    }
                }
            }

            grid = newGrid;
        }

        function drawGrid() {
            for (let y = 0; y < GRID_HEIGHT; y++) {
                for (let x = 0; x < GRID_WIDTH; x++) {
                    if (grid[y][x] == 1) {
                        ctx.fillStyle = 'gold'; // Sand color
                    } else if (hourglassMask[y][x]) {
                        ctx.fillStyle = 'black'; // Empty inside hourglass
                    } else {
                        ctx.fillStyle = '#444'; // Outside hourglass
                    }
                    ctx.fillRect(x * CELL_SIZE, y * CELL_SIZE, CELL_SIZE, CELL_SIZE);
                }
            }
        }

        const FRAME_INTERVAL = 30; // milliseconds per frame

        function loop() {
            updateGrid();
            drawGrid();
        }

        drawGrid(); // Draw initial state
        setInterval(loop, FRAME_INTERVAL);
    </script>
</body>
</html>
